# Plan: RClone Mounts - Offline-Resilienz & Dauerhaft-Modus

## Ziel

Mounts (P:, G:) werden offline-resilient:
- Netzwerk-Check VOR Mount-Versuch
- Status-Datei bei Offline mit Symbol âšª
- Automatischer Retry mit Exponential-Backoff
- "Dauerhaft"-Modus mit Auto-Recovery-Task

---

## Zu Ã¤ndernde Dateien

| Datei                                          | Ã„nderung                                   |
| ---------------------------------------------- | ------------------------------------------ |
| `.Tools/Start-RcloneMounts.ps1`                | Network-Check aufrufen, Retry-Integration  |
| `.Tools/Invoke-RcloneAutomation.ps1`           | Mount-Flow mit Retry-Logik erweitern       |
| `C:\Users\attila\.Secrets\RClone.Secrets.json` | `mount_settings` mit Netzwerk/Retry-Config |

## Neue Dateien

| Datei                                         | Zweck                                             |
| --------------------------------------------- | ------------------------------------------------- |
| `.Tools/Private/Test-NetworkAvailability.ps1` | Provider-spezifische Netzwerk-Tests (TCP-Connect) |
| `.Tools/Private/Start-MountWithRetry.ps1`     | Mount mit Exponential-Backoff-Retry               |

---

## Implementierungsschritte

### 1. `Test-NetworkAvailability.ps1` (neu)

```powershell
function Test-NetworkAvailability {
    param(
        [ValidateSet("gdrive", "pcdrive", "all")]
        [string]$Provider = "all",
        [int]$TimeoutSeconds = 5
    )
    # TCP-Connect zu drive.google.com:443, api.pcloud.com:443
    # Returns: @{ IsOnline = $true/$false; FailedProviders = @() }
}
```

### 2. `Start-MountWithRetry.ps1` (neu)

```powershell
function Start-MountWithRetry {
    param(
        [object]$MountJob,
        [int]$MaxAttempts = 5,
        [int]$BaseDelaySeconds = 10,
        [int]$MaxDelaySeconds = 300
    )
    # 1. Test-NetworkAvailability fÃ¼r Provider
    # 2. Wenn offline: Warten + Retry (10s, 20s, 40s, 80s...)
    # 3. Mount starten, 2s warten, Test-Path auf DriveLetter
    # 4. Bei Misserfolg: Retry
    # Returns: @{ Success = $true/$false; ProcessId; Attempts }
}
```

### 3. `Invoke-RcloneAutomation.ps1` (Ã¤ndern)

- Mount-Section: Ersetze direkten `Start-Process` durch `Start-MountWithRetry`
- Erweitere `Write-MountStatus` um:
  - `NetworkStatus: { IsOnline, LastChecked, FailedProviders }`
  - `Mounts[]: { Id, DriveLetter, State, RetryCount, NextRetryAt }`
  - Neues Symbol âšª fÃ¼r "offline pending"

### 4. `Start-RcloneMounts.ps1` (Ã¤ndern)

- Vor Mount: `Test-NetworkAvailability -Provider "all"` aufrufen
- Bei Offline: Status mit âšª schreiben, Exit 0 (kein Fehler)
- Bei Online: Normaler Mount-Flow mit Retry

### 5. `RClone.Secrets.json` (erweitern)

```json
{
  "facts": {
    "automation": {
      "mount_settings": {
        "network": {
          "check_before_mount": true,
          "timeout_seconds": 5
        },
        "retry": {
          "max_attempts": 5,
          "base_delay_seconds": 10,
          "max_delay_seconds": 300
        }
      }
    }
  }
}
```

### 6. Dauerhaft-Modus (Auto-Recovery)

Neuer Scheduled Task `RcloneMountsAutoRecovery`:
- Trigger: AtLogOn + alle 5 Minuten
- Action: `pwsh -File ".Tools\Start-RcloneMounts.ps1" -LiveRun`
- PrÃ¼ft nur Mounts mit `State = "pending"`

---

## Erweitertes Status-Schema

```json
{
  "Id": "RCloneMountStatus",
  "Symbole": "ðŸŸ¢|ðŸŸ |ðŸ”´|âšª",
  "StatusMessage": "...",
  "NetworkStatus": {
    "IsOnline": false,
    "LastChecked": "2026-02-20T10:00:00",
    "FailedProviders": ["gdrive"]
  },
  "Mounts": [
    {
      "Id": "m1",
      "DriveLetter": "P:",
      "State": "mounted|pending|failed",
      "RetryCount": 2,
      "NextRetryAt": "2026-02-20T10:05:00"
    }
  ]
}
```

**Symbole:**
- ðŸŸ¢ Alle gemountet
- ðŸŸ  Teilweise gemountet
- ðŸ”´ Alle fehlgeschlagen
- âšª Offline, wartet auf Netzwerk

---

## Verifikation

1. **Offline-Test:**
   ```powershell
   # Netzwerk trennen (WiFi aus)
   pwsh -File ".Tools/Start-RcloneMounts.ps1" -LiveRun
   # Erwartet: Status âšª, Exit 0, keine Fehlermeldung
   ```

2. **Online-Test:**
   ```powershell
   # Netzwerk wieder an
   pwsh -File ".Tools/Start-RcloneMounts.ps1" -LiveRun
   # Erwartet: Status ðŸŸ¢, P: und G: erreichbar
   ```

3. **Status-Datei prÃ¼fen:**
   ```powershell
   cat "C:\Users\attila\.logs\ASO\Status\RCloneMountStatus.json"
   ```

4. **Dauerhaft-Modus:**
   ```powershell
   Get-ScheduledTask -TaskName "RcloneMountsAutoRecovery" | Select-Object State, LastRunTime
   ```

---

## Edge Cases

| Szenario                | Behandlung                            |
| ----------------------- | ------------------------------------- |
| P: ok, G: offline       | P: mounten, G: pending                |
| Mount stirbt nach Start | NÃ¤chster Retry-Versuch                |
| WinFsp fehlt            | FrÃ¼hzeitiger Fehler vor Network-Check |
| Mountpoint belegt       | Ãœberspringen, Warning                 |
